<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Node Platformer</title>
	<style>
		body {
			padding: 0px;
			margin: 0px;
			background: #666;
		}
		canvas {
			display: block;
			background-image: url("bg.png");
		}

	</style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var socket = io.connect();

		//canvas vars
		var canvas;
		var CANVAS_W;
		var CANVAS_H;
		var ctx;

		//keypress vars
		var rightKey = false;
		var leftKey = false;
		var upKey = false;
		var downKey = false;
		var fireKey = false;

		//key-binding vars
		var RIGHT = 39;
		var LEFT = 37;
		var UP = 38;
		var DOWN = 40;
		var FIRE = 32;

		//player vars
		var player;
		var players = [];

		//misc vars
		var platforms = [];
		var fireballs = [];
        var port = [];
		var FPS = 150;
        
        var plat = new Image();
        plat.src = "plat.png";

		//game loop
		function gameLoop() {
			clearCanvas();
			drawPlatforms();
			drawPlayers();
			drawFireball();
            drawPortal();
            frameUp();
        }
        
        function frameUp() {
            var tick = 0
            if (tick == 15) {
                frame++;
            }
            tick++;
        }

		//init functions
		function init() {
			canvas = document.getElementById('canvas');
			canvas.width = CANVAS_W;
			canvas.height = CANVAS_H;
			ctx = canvas.getContext('2d');
			document.addEventListener('keydown', keyDown, false);
			document.addEventListener('keyup', keyUp, false);
			setInterval(gameLoop, 1000/FPS);
		}

		//draw functions
		function clearCanvas() {
			ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);
		}

		function drawPlatforms() {
			for (var p in platforms) {
				ctx.drawImage(plat, platforms[p].x, platforms[p].y, platforms[p].w, platforms[p].h);
			}
		}

		function drawPlayers() {
			for (var p in players) {
				ctx.fillStyle = players[p].c;
				ctx.fillRect(players[p].x, players[p].y, players[p].w, players[p].h);
			}
		}

		function drawFireball() {
			for (var f in fireballs) {
				ctx.fillStyle = "red";
				ctx.fillRect(fireballs[f].x, fireballs[f].y, fireballs[f].w, fireballs[f].h);
			}
		}
        
        function drawPortal() {
            for (var p in port) {
                ctx.fillStyle = "white";
                ctx.fillRect(port[p].x, port[p].y, port[p].w, port[p].h);
            }
        }

		//input functions
		function keyDown(e) {
			if (e.keyCode == RIGHT) {
				e.preventDefault();
				socket.emit('keyDown', 'right');
				rightKey = true;
			} else if (e.keyCode == LEFT) {
				e.preventDefault();
				socket.emit('keyDown', 'left');
				leftKey = true;
			}

			if (e.keyCode == UP) {
				e.preventDefault();
				socket.emit('keyDown', 'up');
				upKey = true;
			} else if (e.keyCode == DOWN) {
				e.preventDefault();
				socket.emit('keyDown', 'down');
				downKey = true;
			}

			if (e.keyCode == FIRE) {
				e.preventDefault();
				socket.emit('keyDown', 'fire');
				fireKey = true;
				console.log
			}
		}

		function keyUp(e) {
			if (e.keyCode == RIGHT) {
				socket.emit('keyUp', 'right');
				rightKey = false;
			} else if (e.keyCode == LEFT) {
				socket.emit('keyUp', 'left');
				leftKey = false;
			}

			if (e.keyCode == UP) {
				socket.emit('keyUp', 'up');
				upKey = false;
			} else if (e.keyCode == DOWN) {
				socket.emit('keyUp', 'down');
				downKey = false;
			}

			if (e.keyCode == FIRE) {
				e.preventDefault();
				socket.emit('keyUp', 'fire');
				fireKey = false;
			}
		}

		jQuery(function ($) {
			var nickForm = $('#setNick');
			var nickError = $('#nickError');
			var nickBox = $('#nickname');            
			var users = $('#users');
            var color = $('#pickColor');
            
			nickForm.submit(function (e) {
                var form = [nickBox.val(), color.val()];
                
				e.preventDefault();
				socket.emit('login', form, function (data) {
					if (data) {
						$('#nickWrap').hide();
						$('#contentWrap').show();
						CANVAS_W = data.CANVAS_W;
						CANVAS_H = data.CANVAS_H;
						platforms = data.platforms;
						init();
					} else {
						nickError.html('<h2 style=color:#FFF;>That username is already taken! Please try again.</h2>');
					}
				});
				nickBox.val('');
			});
			socket.on('usernames', function (data) {
				var html = '';
				for (var color in data) {
					html += '<h1 style=color:' + color + ';>' + data[color] + '</h1>';
				}
				users.html(html);
			});
			socket.on('update', function (data) {
				players = data.players;
				fireballs = data.fireballs;
			});
		});
	</script>
</head>

<body>

	<div id="nickWrap" style="margin:50px;">
		<h1 style=color:#FFF;>Enter a username:</h1>
		<p id="nickError"></p>
		<form id="setNick">
			<input type=text style="width:150px;" id="nickname">
            <input type="submit">
		</form>
        
        <select id="pickColor" form="setNick">
            <option selected disabled>Please choose a color</option>
            <option value="red">Red</option>
            <option value="#F7941D">Orange</option>
            <option value="yellow">Yellow</option>
            <option value="lime">Green</option>
            <option value="blue">Blue</option>
            <option value="#2E3192">Indigo</option>
            <option value="#662D91">Violet</option>
            <option value="magenta">Magenta</option>
            <option value="white">White</option>
        </select>
	</div>

	<div style="width:100%;display:none;" id="contentWrap">
		<div style="margin:50px;">
			<div style="float:left;margin-right:15px;">
				<canvas id="canvas"></canvas>
			</div>
			<div id="users"></div>
		</div>
		<div id="output"></div>
	</div>

    <audio autoplay loop><source src=gameLoop.mp3 type=audio/mpeg></audio>
</body>

</html>
